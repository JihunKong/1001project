# Alertmanager ì„¤ì • íŒŒì¼
global:
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@1001stories.org'
  smtp_auth_username: '${SMTP_USER}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

# ì•Œë¦¼ ë¼ìš°íŒ… ê·œì¹™
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook.default'
  routes:
    # ì¤‘ìš”í•œ ì•Œë¦¼ì€ ì¦‰ì‹œ ì „ì†¡
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
    
    # ê²½ê³  ìˆ˜ì¤€ ì•Œë¦¼
    - match:
        severity: warning
      receiver: 'warning-alerts'
      repeat_interval: 30m
    
    # ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ ì•Œë¦¼
    - match:
        service: database
      receiver: 'database-alerts'
      repeat_interval: 15m

# ì•Œë¦¼ ìˆ˜ì‹ ì ì„¤ì •
receivers:
  # ê¸°ë³¸ ìˆ˜ì‹ ì
  - name: 'web.hook.default'
    email_configs:
      - to: 'admin@1001stories.org'
        subject: '[1001Stories] Alert: {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          Severity: {{ .Labels.severity }}
          Time: {{ .StartsAt }}
          {{ end }}
        html: |
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>1001 Stories Alert</title>
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
              .critical { color: #d73027; font-weight: bold; }
              .warning { color: #fc8d59; font-weight: bold; }
              .info { color: #4575b4; }
              .alert-box { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
              .critical .alert-box { border-color: #d73027; background-color: #fef0f0; }
              .warning .alert-box { border-color: #fc8d59; background-color: #fff8f0; }
              .header { background-color: #2c3e50; color: white; padding: 20px; text-align: center; }
              .footer { background-color: #ecf0f1; padding: 10px; text-align: center; font-size: 12px; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>1001 Stories - System Alert</h1>
            </div>
            {{ range .Alerts }}
            <div class="alert-box {{ .Labels.severity }}">
              <h3>{{ .Annotations.summary }}</h3>
              <p><strong>Description:</strong> {{ .Annotations.description }}</p>
              <p><strong>Instance:</strong> {{ .Labels.instance }}</p>
              <p><strong>Severity:</strong> <span class="{{ .Labels.severity }}">{{ .Labels.severity | title }}</span></p>
              <p><strong>Started:</strong> {{ .StartsAt }}</p>
              {{ if .Labels.runbook_url }}
              <p><strong>Runbook:</strong> <a href="{{ .Labels.runbook_url }}">{{ .Labels.runbook_url }}</a></p>
              {{ end }}
            </div>
            {{ end }}
            <div class="footer">
              <p>This alert was generated by the 1001 Stories monitoring system.</p>
              <p>Visit <a href="https://monitoring.1001stories.org">monitoring dashboard</a> for more details.</p>
            </div>
          </body>
          </html>

  # ì¤‘ìš”í•œ ì•Œë¦¼ ìˆ˜ì‹ ì
  - name: 'critical-alerts'
    email_configs:
      - to: 'admin@1001stories.org, devops@1001stories.org'
        subject: '[CRITICAL] 1001 Stories System Alert'
        body: |
          ğŸš¨ CRITICAL ALERT ğŸš¨
          
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          Time: {{ .StartsAt }}
          
          Please take immediate action!
          {{ end }}
    # Slack ì›¹í›… ì„¤ì • (ì„ íƒì‚¬í•­)
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts'
        title: 'ğŸš¨ Critical Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          Started: {{ .StartsAt }}
          {{ end }}
        color: 'danger'

  # ê²½ê³  ìˆ˜ì¤€ ì•Œë¦¼ ìˆ˜ì‹ ì
  - name: 'warning-alerts'
    email_configs:
      - to: 'admin@1001stories.org'
        subject: '[WARNING] 1001 Stories System Warning'
        body: |
          âš ï¸ WARNING âš ï¸
          
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          Time: {{ .StartsAt }}
          {{ end }}
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#monitoring'
        title: 'âš ï¸ Warning: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          {{ end }}
        color: 'warning'

  # ë°ì´í„°ë² ì´ìŠ¤ ì•Œë¦¼ ìˆ˜ì‹ ì
  - name: 'database-alerts'
    email_configs:
      - to: 'admin@1001stories.org, dba@1001stories.org'
        subject: '[DATABASE] 1001 Stories Database Alert'
        body: |
          ğŸ—ƒï¸ DATABASE ALERT ğŸ—ƒï¸
          
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          Time: {{ .StartsAt }}
          {{ end }}

# ì•Œë¦¼ ì–µì œ ê·œì¹™ (ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€)
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']
  
  - source_match:
      alertname: 'InstanceDown'
    target_match_re:
      alertname: '.*'
    equal: ['instance']

# ì•Œë¦¼ í…œí”Œë¦¿ ì„¤ì •
templates:
  - '/etc/alertmanager/templates/*.tmpl'