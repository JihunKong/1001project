# Alertmanager 설정 파일
global:
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@1001stories.org'
  smtp_auth_username: '${SMTP_USER}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

# 알림 라우팅 규칙
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook.default'
  routes:
    # 중요한 알림은 즉시 전송
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
    
    # 경고 수준 알림
    - match:
        severity: warning
      receiver: 'warning-alerts'
      repeat_interval: 30m
    
    # 데이터베이스 관련 알림
    - match:
        service: database
      receiver: 'database-alerts'
      repeat_interval: 15m

# 알림 수신자 설정
receivers:
  # 기본 수신자
  - name: 'web.hook.default'
    email_configs:
      - to: 'admin@1001stories.org'
        subject: '[1001Stories] Alert: {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          Severity: {{ .Labels.severity }}
          Time: {{ .StartsAt }}
          {{ end }}
        html: |
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>1001 Stories Alert</title>
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
              .critical { color: #d73027; font-weight: bold; }
              .warning { color: #fc8d59; font-weight: bold; }
              .info { color: #4575b4; }
              .alert-box { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
              .critical .alert-box { border-color: #d73027; background-color: #fef0f0; }
              .warning .alert-box { border-color: #fc8d59; background-color: #fff8f0; }
              .header { background-color: #2c3e50; color: white; padding: 20px; text-align: center; }
              .footer { background-color: #ecf0f1; padding: 10px; text-align: center; font-size: 12px; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>1001 Stories - System Alert</h1>
            </div>
            {{ range .Alerts }}
            <div class="alert-box {{ .Labels.severity }}">
              <h3>{{ .Annotations.summary }}</h3>
              <p><strong>Description:</strong> {{ .Annotations.description }}</p>
              <p><strong>Instance:</strong> {{ .Labels.instance }}</p>
              <p><strong>Severity:</strong> <span class="{{ .Labels.severity }}">{{ .Labels.severity | title }}</span></p>
              <p><strong>Started:</strong> {{ .StartsAt }}</p>
              {{ if .Labels.runbook_url }}
              <p><strong>Runbook:</strong> <a href="{{ .Labels.runbook_url }}">{{ .Labels.runbook_url }}</a></p>
              {{ end }}
            </div>
            {{ end }}
            <div class="footer">
              <p>This alert was generated by the 1001 Stories monitoring system.</p>
              <p>Visit <a href="https://monitoring.1001stories.org">monitoring dashboard</a> for more details.</p>
            </div>
          </body>
          </html>

  # 중요한 알림 수신자
  - name: 'critical-alerts'
    email_configs:
      - to: 'admin@1001stories.org, devops@1001stories.org'
        subject: '[CRITICAL] 1001 Stories System Alert'
        body: |
          🚨 CRITICAL ALERT 🚨
          
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          Time: {{ .StartsAt }}
          
          Please take immediate action!
          {{ end }}
    # Slack 웹훅 설정 (선택사항)
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts'
        title: '🚨 Critical Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          Started: {{ .StartsAt }}
          {{ end }}
        color: 'danger'

  # 경고 수준 알림 수신자
  - name: 'warning-alerts'
    email_configs:
      - to: 'admin@1001stories.org'
        subject: '[WARNING] 1001 Stories System Warning'
        body: |
          ⚠️ WARNING ⚠️
          
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          Time: {{ .StartsAt }}
          {{ end }}
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#monitoring'
        title: '⚠️ Warning: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          {{ end }}
        color: 'warning'

  # 데이터베이스 알림 수신자
  - name: 'database-alerts'
    email_configs:
      - to: 'admin@1001stories.org, dba@1001stories.org'
        subject: '[DATABASE] 1001 Stories Database Alert'
        body: |
          🗃️ DATABASE ALERT 🗃️
          
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          Time: {{ .StartsAt }}
          {{ end }}

# 알림 억제 규칙 (중복 알림 방지)
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']
  
  - source_match:
      alertname: 'InstanceDown'
    target_match_re:
      alertname: '.*'
    equal: ['instance']

# 알림 템플릿 설정
templates:
  - '/etc/alertmanager/templates/*.tmpl'